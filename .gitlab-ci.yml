image: node:14-alpine

# Define stages
stages:
  - test
  - deploy

# This folder is cached between builds
# http://docs.gitlab.com/ce/ci/yaml/README.html#cache
cache:
  paths:
    - node_modules/

test_async:
  stage: test
  script:
    - yarn install --frozen-lockfile
    - yarn test
    - yarn lint

# Upload translations to Lokalise when PR is merged to main
upload_translations:
  stage: deploy
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"
      when: on_success
    - when: never
  before_script:
    - yarn install --frozen-lockfile
  script:
    - echo "üì§ Uploading translations to Lokalise..."
    - echo "üîç Checking environment variables..."
    - |
      if [ -z "$LOKALISE_PROJECT_ID" ]; then
        echo "‚ùå LOKALISE_PROJECT_ID is not set"
        exit 1
      fi
    - |
      if [ -z "$LOKALISE_API_TOKEN" ]; then
        echo "‚ùå LOKALISE_API_TOKEN is not set"
        exit 1
      fi
    - echo "‚úÖ Environment variables are set"
    - yarn translations:upload

  variables:
    LOKALISE_PROJECT_ID: $LOKALISE_PROJECT_ID
    LOKALISE_API_TOKEN: $LOKALISE_API_TOKEN

variables:
  DEPENDABOT_IMAGE: docker.io/andrcuns/dependabot-gitlab:0.23.0

.dependabot-gitlab:
  image:
    name: $DEPENDABOT_IMAGE
    entrypoint: ['']
  variables:
    GIT_STRATEGY: none
    RAILS_ENV: production
    SECRET_KEY_BASE: key
    PACKAGE_MANAGER: npm
    SETTINGS__GITLAB_URL: $CI_SERVER_URL
    SETTINGS__STANDALONE: 'true'
    SETTINGS__LOG_COLOR: 'true'
  script:
    - cd /home/dependabot/app
    - bundle exec rake "dependabot:update[$PROJECT_PATH,$PACKAGE_MANAGER,$DIRECTORY]"

dependabot:
  extends: .dependabot-gitlab
  rules:
    - if: $DEPENDENCY_UPDATES_DISABLED
      when: never
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $PACKAGE_MANAGER_SET =~ /(\bnpm|yarn\b)/'
